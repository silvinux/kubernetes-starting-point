<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Buildah or Dockerfile, which to choose when building images? :: Kubernetes, where should I start?</title>
    <link rel="canonical" href="https://silvinux.github.io/kubernetes-starting-point/containers/04-image-creation.html">
    <link rel="prev" href="03-container-tools.html">
    <link rel="next" href="05-running-containers.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://silvinux.github.io/kubernetes-starting-point">Kubernetes, where should I start?</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="containers" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-introduction.html">Get Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-introduction.html#container-techonologies">container-techonologies</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-oci.html">OCI</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-oci.html##oci-intro">What is OCI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-oci.html#oci-specs">OCI specifications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-oci.html#oci-implementation">OCI implementation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-container-tools.html">Container tools</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-container-tools.html#tools-buildah-podman">buildah-podman</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-image-creation.html">Image Creation and Build</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#image-build-declarative">image-build-declarative</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#image-build-imperative">image-build-imperative</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-running-containers.html">Run a container and verify it works</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-running-containers.html#testing-declarative">testing-declarative</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-running-containers.html#testing-imperative">testing-imperative</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">k8s</a></li>
    <li><a href="04-image-creation.html">Image Creation and Build</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/silvinux/kubernetes-starting-point/edit/master/documentation/modules/ROOT/pages/04-image-creation.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Buildah or Dockerfile, which to choose when building images?</h1>
<div id="preamble">
<div class="sectionbody">
<div id="image-build-type" class="paragraph">
<p>To build container images it can be used two approaches based on programming language:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://en.wikipedia.org/wiki/Imperative_programming">Imperative</a>: It will be focused on executing in the command line step by step all the commands needed to get the final image to be used in the container. This approach is pretty useful when automation is needed and a lot of steps are custom or need to be taken from different sources.</p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Declarative_programming">Declarative</a>: It will be used as a source of the steps and information that needs to be passed to build the image. This file could be named Dockerfile or Containerfile, depending on the tools that it will be used to create the image. Most of the tools accept Containerfile except Docker.  This approach does not need to know the actual commands that need to be executed in order to add each step to the resultant images.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="image-build-declarative"><a class="anchor" href="#image-build-declarative"></a>Declarative approach fot building the image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let’s start with the declarative approach because it is simpler and is the best-known in the community.</p>
</div>
<div class="paragraph">
<p>Create a directory to build a new fresh image.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mkdir -p ~/custom-apline-net/src;cd ~/custom-apline-net</code></pre>
</div>
</div>
<div class="paragraph">
<p>A Containerfile will be used due it seems more generic than Dockerfile. This file  is needed in order to give the instructions or commands that needs to be executed in the container image:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt; EOF  &gt; Containerfile
# Alpine-net
# Alpine image with network tools

FROM alpine:latest

MAINTAINER silvinux &lt;<a href="mailto:silvinux7@gmail.com">silvinux7@gmail.com</a>&gt;

RUN apk --update add bash python3 conntrack-tools coreutils curl drill iperf3 iproute2 iptables iputils ip6tables keepalived net-tools nftables socat ethtool mtr tcpdump busybox-extras &amp;&amp; rm -rf /var/cache/apk/*

RUN adduser -D -u 1000 container

USER container

WORKDIR /home/container

RUN echo "Hello Kubernetes, DECLARATIVE"  &gt; index.html

CMD ["python3","-m","http.server","8080"]

EXPOSE 8080
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>It could be used buildah or podman to build the image. Buildah will be used as it supports image building from the Containerfile.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">buildah bud -t alpine-net .
STEP 1: FROM alpine:latest
STEP 2: MAINTAINER silvinux &lt;<a href="mailto:silvinux7@gmail.com">silvinux7@gmail.com</a>&gt;
STEP 3: RUN apk --update add bash python3 conntrack-tools coreutils curl drill iperf3 iproute2 iptables iputils ip6tables keepalived net-tools nftables socat ethtool mtr tcpdump busybox-extras &amp;&amp; rm -rf /var/cache/apk/*
fetch <a href="https://dl-cdn.alpinelinux.org/alpine/v3.13/main/x86_64/APKINDEX.tar.gz" class="bare">https://dl-cdn.alpinelinux.org/alpine/v3.13/main/x86_64/APKINDEX.tar.gz</a>
fetch <a href="https://dl-cdn.alpinelinux.org/alpine/v3.13/community/x86_64/APKINDEX.tar.gz" class="bare">https://dl-cdn.alpinelinux.org/alpine/v3.13/community/x86_64/APKINDEX.tar.gz</a>
(1/57) Installing ncurses-terminfo-base (6.2_p20210109-r0)
(2/57) Installing bash (5.1.0-r0)
...
(56/57) Installing python3 (3.8.8-r0)
(57/57) Installing tcpdump (4.99.0-r0)
Executing busybox-1.32.1-r6.trigger
Executing ca-certificates-20191127-r5.trigger
OK: 72 MiB in 71 packages
STEP 4: RUN adduser -D -u 1000 container
STEP 5: USER container
STEP 6: WORKDIR /home/container
STEP 7: CMD ["/bin/sh"]
STEP 8: COMMIT alpine-net
Getting image source signatures
Copying blob b2d5eeeaba3a skipped: already exists
Copying blob 200e3c5139a6 done
Copying config 0a8e9bd5f9 done
Writing manifest to image destination
Storing signatures
--&gt; 0a8e9bd5f9c
0a8e9bd5f9c7f9aa577d09a2220c7996946f02a5411737eaf819582d9ddab85f</code></pre>
</div>
</div>
<div class="paragraph">
<p>Shown above, when you build the container from the above Dockerfile, each step corresponds to a command run in the Containerfile. Each layer is made up of the file generated by running that command. Along with each step, the layer created is represented by its random hashed generated ID.</p>
</div>
<div class="paragraph">
<p>The buildah bud command creates a new image named alpine-net. To see the new image in local, the below command is used:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">buildah images
REPOSITORY                                           TAG      IMAGE ID       CREATED         SIZE
localhost/alpine-net                                 latest   0a8e9bd5f9c7   2 minutes ago   70.2 MB</code></pre>
</div>
</div>
<div class="paragraph">
<p>Buildah command can inspect the image metadata once it is built, in case we need to check information and layers of that image.</p>
</div>
<div class="paragraph">
<p>For instance, the below command could be executed to inspect the image called alpine-net that it has been created to get some of the parameter instructed into the Containerfile :</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">buildah inspect localhost/alpine-net |jq '.OCIv1|{author,config,rootfs}'
{
  "author": "silvinux &lt;<a href="mailto:silvinux7@gmail.com">silvinux7@gmail.com</a>&gt;",
  "config": {
    "User": "container",
    "ExposedPorts": {
      "9090/tcp": {}
    },
    "Env": [
      "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    ],
    "Cmd": [
      "python3",
      "-m",
      "http.server",
      "9090"
    ],
    "WorkingDir": "/home/container",
    "Labels": {
      "io.buildah.version": "1.26.1"
    }
  },
  "rootfs": {
    "type": "layers",
    "diff_ids": [
      "sha256:f1417ff83b319fbdae6dd9cd6d8c9c88002dcd75ecf6ec201c8c6894681cf2b5",
      "sha256:b5fa209e7ff1cbc00ef2364e1864c2be22e4349c0840290a85bc0e8a27f159ef"
    ]
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="image-build-imperative"><a class="anchor" href="#image-build-imperative"></a>Imperative approach fot building the image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now is the turn to demonstrate how to create the same image through the imperative approach. In order to simplify the process, a script has been provided to create and build the image. It should be considered that the ports and name of the image has been changed in order to make both images run at the same time.</p>
</div>
<div class="paragraph">
<p><strong>script</strong></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt; EOF &gt; buidah-imperative-script.sh
#!/bin/bash

set -x

# Make sure there is no container start with same name
buildah rm alpine-net-working-container
podman rm alpine-net-imperative -f

# Build minimal image from Alpine
buildah from --name "alpine-net-working-container" alpine:latest

# Install packages needed to execute a python web server and net tools
buildah run alpine-net-working-container -- apk --update add bash python3 conntrack-tools coreutils curl drill iperf3 iproute2 iptables iputils ip6tables keepalived net-tools nftables socat ethtool mtr tcpdump busybox-extras

# Add a user to work with inside the container
buildah run alpine-net-working-container adduser -D -u 1000 container

# Set user to work with inside the container
buildah config --user container alpine-net-working-container

# Set working directory that will be use inside the container
buildah config --workingdir /home/container alpine-net-working-container

# Create a index.html file and copy inside the image
echo "Hello Kubernetes, IMPERATIVE" &gt; index.html
buildah copy alpine-net-working-container index.html /home/container/index.html

# Add the command that must be executed to start the web server in port 9090
buildah config --cmd "python3 -m http.server 9090" alpine-net-working-container

# Expose port 9090
buildah config --port 9090 alpine-net-working-container

# Commit image
buildah commit alpine-net-working-container alpine-net-imperative

# Show local images
buildah images

# run container
# podman run -dit -p9090:9090 --name alpine-net-imperative localhost/alpine-net-imperative
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to review the image, buildah inspect will be used to check the new image.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"> buildah inspect localhost/alpine-net-imperative |jq '.OCIv1|{author   master fs}'
{
  "author": null,
  "config": {
    "User": "container",
    "ExposedPorts": {
      "9090": {}
    },
    "Env": [
      "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    ],
    "Cmd": [
      "python3",
      "-m",
      "http.server",
      "9090"
    ],
    "WorkingDir": "/home/container",
    "Labels": {
      "io.buildah.version": "1.26.1"
    }
  },
  "rootfs": {
    "type": "layers",
    "diff_ids": [
      "sha256:f1417ff83b319fbdae6dd9cd6d8c9c88002dcd75ecf6ec201c8c6894681cf2b5",
      "sha256:0a2e865ceabab8661e512c5d61d55ae45c9eb227b95f45019b5666f92fd6a2ff"
    ]
  }
}</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="03-container-tools.html">Container tools</a></span>
  <span class="next"><a href="05-running-containers.html">Run a container and verify it works</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
